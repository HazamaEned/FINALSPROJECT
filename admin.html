<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="admin.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>

<body>
  <div id="sidebar">
    <div id="sidebar-header">
      <img id="apollogo" src="logomed.png" alt="apollogo" />
    </div>

    <div id="sidebar-nav">
      <a href="#" class="nav-item active">
        <img src="icons/dashboard.png" alt="Dashboard" class="nav-icon" />
      </a>
       <a href="inventory.html" class="nav-item">
        <img src="icons/inventory.png" alt="Inventory" class="nav-icon" />
      </a>
      <a href="account.html" class="nav-item">
        <img src="icons/account.png" alt="Account" class="nav-icon" />
      </a>
      <a href="admin-transaction-history.html" class="nav-item">
        <img src="icons/history.png" alt="History" class="nav-icon" />
      </a>
      <a href="settings.html" class="nav-item">
        <img src="icons/setting.png" alt="Settings" class="nav-icon" />
      </a>
    </div>

    <div id="sidebar-footer">
      <a href="login.html" class="nav-item">
        <img src="icons/power-off.png" alt="Logout" class="nav-icon" />
      </a>
    </div>
  </div>

  <div id="main-content">
    <div id="DashboardContainer">
      <div class="kpi-grid">
        <div class="kpi-card revenue-card">
          <div id="kpi-total-sales" class="kpi-value">â‚±0.00</div>
           <div class="kpi-label">Transactions</div>
          <div class="kpi-trend positive"><span class="trend-icon"></span></div>
        </div>
        <div class="kpi-card">
          <div id="kpi-total-transactions" class="kpi-value">0</div>
          <div class="kpi-label">Transactions</div>
          <div class="kpi-trend positive"><span class="trend-icon"></span></div>
        </div>
        <div class="kpi-card">
          <div id="kpi-avg-transaction" class="kpi-value">â‚±0.00</div>
          <div class="kpi-label">Avg. Transaction</div>
          <div class="kpi-trend positive"><span class="trend-icon"></span></div>
        </div>
        <div class="kpi-card">
          <div id="kpi-low-stock" class="kpi-value">0</div>
          <div class="kpi-label">Low Stock</div>
          <div class="kpi-trend negative"><span class="trend-icon"></span></div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-panel">
          <div class="chart-header">
            <h3 class="chart-title">Sales Summary</h3>
          </div>
          <canvas id="salesChart" height="150"></canvas>
        </div>

        <div class="products-panel">
          <div class="panel-header">
            <h3 class="panel-title">Top Products</h3>
          </div>
          <div id="top-products" class="products-list"></div>
        </div>
      </div>

      <div class="bottom-grid">
        <div class="table-panel">
          <div class="panel-header">
            <h3 class="panel-title">Recent Transactions</h3>
            <button id="export-btn" class="view-all-btn">Export CSV</button>
          </div>
          <div class="table-container">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>Transaction ID</th>
                  <th>Cashier</th>
                  <th>Total</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="transactions-table"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const STORAGE_TRANSACTIONS_KEY = 'pos_transactions';
    const STORAGE_PRODUCTS_KEY = 'pos_products';

    function getData(key) {
      try {
        return JSON.parse(localStorage.getItem(key)) || [];
      } catch {
        return [];
      }
    }

    function formatCurrency(value) {
      return 'â‚±' + Number(value).toFixed(2);
    }

    function updateDashboard() {
      const txs = getData(STORAGE_TRANSACTIONS_KEY);
      const products = getData(STORAGE_PRODUCTS_KEY);

      const totalSales = txs.reduce((a, b) => a + (b.total || 0), 0);
      const totalTransactions = txs.length;
      const avgTransaction = totalTransactions ? totalSales / totalTransactions : 0;
      const lowStockCount = products.filter(p => p.stock < 10).length;

      document.getElementById('kpi-total-sales').textContent = formatCurrency(totalSales);
      document.getElementById('kpi-total-transactions').textContent = totalTransactions;
      document.getElementById('kpi-avg-transaction').textContent = formatCurrency(avgTransaction);
      document.getElementById('kpi-low-stock').textContent = lowStockCount;

      const table = document.getElementById('transactions-table');
      const recent = txs.slice(-10).reverse();
      table.innerHTML = recent.length
        ? recent.map(t => `
          <tr>
            <td>${t.id || 'N/A'}</td>
            <td>${t.cashier || 'â€”'}</td>
            <td>${formatCurrency(t.total)}</td>
            <td>${new Date(t.timestamp).toLocaleString()}</td>
          </tr>`).join('')
        : '<tr><td colspan="4" style="text-align:center;">No transactions yet</td></tr>';

      const topProducts = [...products].sort((a, b) => b.stock - a.stock).slice(0, 5);
      const topProductsDiv = document.getElementById('top-products');
      topProductsDiv.innerHTML = topProducts.length
        ? topProducts.map(p => `
            <div class="product-item">
              <div class="product-image"><div class="product-placeholder">ðŸ’Š</div></div>
              <div class="product-info">
                <div class="product-name">${p.name}</div>
                <div class="product-sold">${p.stock} units</div>
              </div>
              <div class="product-price">${formatCurrency(p.price || 0)}</div>
            </div>`).join('')
        : '<div class="placeholder-text">No product data</div>';

      updateSalesChart(txs);
    }

    function updateSalesChart(txs) {
      const ctx = document.getElementById('salesChart');
      const salesByDay = {};

      txs.forEach(t => {
        const date = new Date(t.timestamp).toLocaleDateString();
        salesByDay[date] = (salesByDay[date] || 0) + (t.total || 0);
      });

      const labels = Object.keys(salesByDay).slice(-10);
      const data = Object.values(salesByDay).slice(-10);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Sales',
            data,
            backgroundColor: ['#C43E38'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { color: '#374151' } },
            x: { ticks: { color: '#374151' } }
          }
        }
      });
    }

    document.getElementById('export-btn').addEventListener('click', () => {
      const txs = getData(STORAGE_TRANSACTIONS_KEY);
      if (!txs.length) return alert('No data to export');
      const csv = 'Transaction ID,Cashier,Total,Date\n' +
        txs.map(t => `${t.id},${t.cashier || ''},${t.total},${new Date(t.timestamp).toLocaleString()}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'transactions.csv';
      a.click();
      URL.revokeObjectURL(url);
    });

    updateDashboard();
  </script>
</body>
</html>
